<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <style>
        /* Basic Styling - Mimicking Ant Design card and centering */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .reset-password-container {
            width: 100%;
            max-width: 400px;
            padding: 24px;
        }
        .reset-password-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px 0 rgba(0, 0, 0, 0.02);
            padding: 24px;
        }
        .text-center {
            text-align: center;
        }
        .form-group {
            margin-bottom: 16px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        input[type="password"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .ant-btn-primary {
            width: 100%;
            padding: 8px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .ant-btn-primary:disabled {
            background-color: #a0cfff;
            cursor: not-allowed;
        }
        /* Loader/Spinner Simulation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #1890ff;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="reset-password-container">
        <div id="loading-state" class="text-center" style="display: none;">
            <div class="spinner"></div>
            <p>Validating token...</p>
        </div>

        <div id="invalid-token-state" class="reset-password-card" style="display: none;">
            <h3 class="text-center">Invalid Reset Link</h3>
            <p class="text-center" style="margin-bottom: 16px;">
                The password reset link is missing or invalid. Please check your email for the correct link.
            </p>
            <button class="ant-btn-primary" onclick="window.location.href='/'">
                Back to Login
            </button>
        </div>

        <div id="reset-form-state" class="reset-password-card" style="display: none;">
            <h3 class="text-center">Reset Your Password</h3>
            
            <form id="reset-password-form">
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password" required>
                    <small id="newPassword-error" style="color: red; display: none;"></small>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" required>
                    <small id="confirmPassword-error" style="color: red; display: none;"></small>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="ant-btn-primary" id="submit-button">
                        Reset Password
                    </button>
                </div>
            </form>
        </div>

    </div>

    <script>
        // Configuration
        const API_BASE_URL = "https://cuisinous-backend-dev-test.onrender.com"; // Replace with your actual config value

        // DOM Elements
        const loadingState = document.getElementById('loading-state');
        const invalidTokenState = document.getElementById('invalid-token-state');
        const resetFormState = document.getElementById('reset-form-state');
        const form = document.getElementById('reset-password-form');
        const newPasswordField = document.getElementById('newPassword');
        const confirmPasswordField = document.getElementById('confirmPassword');
        const submitButton = document.getElementById('submit-button');
        const newPasswordError = document.getElementById('newPassword-error');
        const confirmPasswordError = document.getElementById('confirmPassword-error');
        
        // State Variables (Simulating React state)
        let token = null;
        let tokenValid = false;
        let loading = false;

        // --- Utility Functions ---

        // Simple validation function based on the Ant Design rules
        const validatePassword = (password) => {
            const errors = [];
            if (password.length < 8) errors.push("Password must be at least 8 characters");
            if (!/[A-Z]/.test(password)) errors.push("Must contain at least one uppercase letter");
            if (!/[a-z]/.test(password)) errors.push("Must contain at least one lowercase letter");
            if (!/[0-9]/.test(password)) errors.push("Must contain at least one number");
            if (!/[\W]/.test(password)) errors.push("Must contain at least one special character");
            return errors;
        };

        // --- Rendering Logic (Replaces React's return statements) ---
        const render = () => {
            // Hide all states first
            loadingState.style.display = 'none';
            invalidTokenState.style.display = 'none';
            resetFormState.style.display = 'none';

            if (!token) {
                // Renders the 'Invalid Reset Link' message for a missing token
                invalidTokenState.style.display = 'block';
            } else if (loading && !tokenValid) {
                // Renders the 'Validating token...' spinner
                loadingState.style.display = 'block';
            } else if (tokenValid) {
                // Renders the main reset password form
                resetFormState.style.display = 'block';
            } else {
                // Renders the 'Invalid Reset Link' message if validation failed
                invalidTokenState.style.display = 'block';
            }
            
            // Update button state
            submitButton.disabled = loading || !tokenValid;
            submitButton.textContent = loading ? 'Resetting...' : 'Reset Password';
        };

        // --- Core Logic (Simulating React Hooks and Functions) ---

        const navigateToHome = () => {
            window.location.href = '/'; // Simple redirection to the root
        };

        const validateToken = async () => {
            loading = true;
            render(); // Show loading state

            try {
                const response = await fetch(
                    `${API_BASE_URL}/api/user/password-reset/validate/${token}`
                );
                
                if (response.status === 200) {
                    tokenValid = true;
                } else {
                    // Treat any non-200 status as invalid/expired
                    alert("Error: Invalid or expired token");
                    navigateToHome();
                }
            } catch (error) {
                // Handle network errors
                alert("Error: Invalid or expired token");
                navigateToHome();
            } finally {
                loading = false;
                render(); // Update UI
            }
        };

        const handleFormSubmit = async (e) => {
            e.preventDefault();

            const newPassword = newPasswordField.value;
            const confirmPassword = confirmPasswordField.value;

            // Client-side validation
            const newPasswordErrors = validatePassword(newPassword);
            
            newPasswordError.textContent = newPasswordErrors.join(', ');
            newPasswordError.style.display = newPasswordErrors.length > 0 ? 'block' : 'none';

            if (newPassword !== confirmPassword) {
                confirmPasswordError.textContent = "The two passwords don't match!";
                confirmPasswordError.style.display = 'block';
                return;
            } else {
                confirmPasswordError.style.display = 'none';
            }

            if (newPasswordErrors.length > 0) {
                return;
            }

            // API Call to confirm reset
            loading = true;
            render(); 

            try {
                const response = await fetch(`${API_BASE_URL}/api/user/password-reset/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token,
                        newPassword: newPassword,
                    }),
                });

                if (response.ok) {
                    alert("Success: Password has been reset successfully!");
                    navigateToHome();
                } else {
                    const errorData = await response.json();
                    alert(`Failed to reset password: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                alert("An unexpected network error occurred");
            } finally {
                loading = false;
                render();
            }
        };

        // --- Initialization (Simulating the initial render and useEffect) ---

        document.addEventListener('DOMContentLoaded', () => {
            // Get token from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            token = urlParams.get("token");

            // Initial render
            render(); 

            // If token exists, start validation (Simulates useEffect)
            if (token) {
                validateToken();
            }

            // Attach event listener to the form
            form.addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>